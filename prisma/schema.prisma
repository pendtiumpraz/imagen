generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum Role {
  USER
  ADMIN
}

enum SubscriptionPlan {
  FREE
  BASIC
  PRO
}

enum GenerationCategory {
  POSTER_KAJIAN
  POSTER_DAKWAH
  THUMBNAIL_KAJIAN
  POSTER_RAMADHAN
  POSTER_JUMAT
  KARTU_UCAPAN_ISLAMI
  POSTER_KEGIATAN
  POSTER_SEKOLAH
  POSTER_PPDB
  POSTER_TAHFIDZ
  POSTER_PESANTREN
  POSTER_DONASI
  POSTER_UMRAH_HAJI
  POSTER_NIKAH
  POSTER_AQIQAH
  POSTER_MAULID
  POSTER_ISRA_MIRAJ
  POSTER_TAHUN_BARU_HIJRIAH
  COVER_BUKU_ISLAMI
  LOGO_ISLAMI
  POSTER_PRODUK
  BANNER_PROMO
  THUMBNAIL_MARKETPLACE
  FEED_INSTAGRAM
  STORY_INSTAGRAM
}

enum GenerationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum CouponType {
  EXTRA_QUOTA
  DISCOUNT
  QUOTA_BOOST
}

// ==================== MODELS ====================

model User {
  id            String           @id @default(cuid())
  name          String
  email         String           @unique
  phone         String?          @unique
  password      String
  role          Role             @default(USER)
  plan          SubscriptionPlan @default(FREE)
  monthlyQuota  Int              @default(2)
  lifetimeQuota Int              @default(2)
  customQuota   Int?
  bonusQuota    Int              @default(0)
  isBanned      Boolean          @default(false)
  banReason     String?
  fraudAttempts Int              @default(0)
  avatarUrl     String?

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  generations        Generation[]
  subscriptions      Subscription[]
  brandPresets       BrandPreset[]
  payments           PaymentConfirmation[]
  monthlyUsages      MonthlyUsage[]
  couponRedemptions  CouponRedemption[]

  @@index([email])
  @@index([deletedAt])
}

model Generation {
  id       String             @id @default(cuid())
  userId   String
  category GenerationCategory
  status   GenerationStatus   @default(PENDING)

  prompt          String  @db.Text
  enhancedPrompt  String? @db.Text
  referenceImages String[]
  aspectRatio     String  @default("1:1")

  resultImageUrl String?
  resultMetadata Json?

  errorMessage String?

  isPublic Boolean @default(true)
  isFraudAttempt Boolean @default(false)

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([userId, createdAt])
  @@index([deletedAt])
  @@index([isPublic, category, createdAt])
}

model Subscription {
  id        String           @id @default(cuid())
  userId    String
  plan      SubscriptionPlan
  price     Int
  startDate DateTime
  endDate   DateTime
  isActive  Boolean          @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([endDate])
}

model AIProvider {
  id       String  @id @default(cuid())
  name     String  @unique
  apiKey   String
  baseUrl  String
  modelId  String?
  isActive Boolean @default(true)
  config   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TempFile {
  id           String   @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  url          String
  expiresAt    DateTime

  createdAt DateTime @default(now())

  @@index([expiresAt])
}

// Monthly usage tracking (replaces DailyUsage)
model MonthlyUsage {
  id     String @id @default(cuid())
  userId String
  month  String // format "YYYY-MM"
  count  Int    @default(0)

  @@unique([userId, month])
  @@index([userId, month])

  user User @relation(fields: [userId], references: [id])
}

// Keep DailyUsage for backward compat but it won't be used anymore
model DailyUsage {
  id     String   @id @default(cuid())
  userId String
  date   DateTime @db.Date
  count  Int      @default(0)

  @@unique([userId, date])
  @@index([userId, date])
}

// Brand presets - save brand identity for consistency
model BrandPreset {
  id          String  @id @default(cuid())
  userId      String
  name        String  // preset name e.g. "Masjid Al-Ikhlas"
  isDefault   Boolean @default(false)

  // Brand info
  brandName   String?
  logoUrl     String?

  // Color & style preferences
  style       String?  // e.g. "realistic", "3d"
  colorPalette String?
  customColor String?
  background  String?
  customBackground String?
  elements    String[] // array of element IDs

  // Social media
  socials     Json?    // { instagram: "@xyz", whatsapp: "08xx", ... }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

// Payment confirmation
model PaymentConfirmation {
  id           String        @id @default(cuid())
  userId       String
  plan         SubscriptionPlan
  amount       Int           // Rp
  status       PaymentStatus @default(PENDING)

  // Transfer proof
  proofImageUrl String?
  senderName    String?
  senderBank    String?
  transferDate  String?
  notes         String?      @db.Text

  // Admin response
  adminNotes   String?       @db.Text
  reviewedAt   DateTime?
  reviewedBy   String?       // admin user ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
}

model SystemSetting {
  id          String  @id @default(cuid())
  key         String  @unique
  value       String  @db.Text
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Coupon codes for bonus quota or discounts
model Coupon {
  id          String     @id @default(cuid())
  code        String     @unique
  type        CouponType
  value       Int        // EXTRA_QUOTA: jumlah image, DISCOUNT: persen, QUOTA_BOOST: jumlah boost
  maxUses     Int        @default(100)
  usedCount   Int        @default(0)
  expiresAt   DateTime
  description String?    @db.Text  // Syarat & ketentuan
  isActive    Boolean    @default(true)

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  redemptions CouponRedemption[]
}

// Track who redeemed which coupon (1x per user per coupon)
model CouponRedemption {
  id        String   @id @default(cuid())
  userId    String
  couponId  String

  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  coupon Coupon @relation(fields: [couponId], references: [id])

  @@unique([userId, couponId])
  @@index([userId])
  @@index([couponId])
}
